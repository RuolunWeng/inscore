<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>14 Scripting</title> 
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"> 
<meta name="generator" content="TeX4ht (http://www.tug.org/tex4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.tug.org/tex4ht/)"> 
<!-- html,2,frames,index=3,info --> 
<meta name="src" content="OSCMsg.tex"> 
<meta name="date" content="2014-12-15 16:26:00"> 
<link rel="stylesheet" type="text/css" href="OSCMsg.css"> 
</head><body 
>
<!--l. 2575--><div class="crosslinks"><p class="noindent">[<a 
href="OSCMsgch15.html" >next</a>] [<a 
href="OSCMsgch13.html" >prev</a>] [<a 
href="OSCMsgch13.html#tailOSCMsgch13.html" >prev-tail</a>] [<a 
href="#tailOSCMsgch14.html">tail</a>] [<a 
href="OSCMsg3.html#OSCMsgch14.html" >up</a>] </p></div>
<h2 class="chapterHead"><span class="titlemark">Chapter&#x00A0;14</span><br /><a 
 id="x18-8300014"></a>Scripting</h2>
<!--l. 2578--><p class="noindent" >INScore saves its state to files containing textual OSC messages. These files can be edited or created from scratch
using any text editor. In order to provide users with a scripting language, the OSC syntax has been extended at
textual level.
<h3 class="sectionHead"><span class="titlemark">14.1    </span> <a 
 id="x18-8400014.1"></a>Statements</h3>
<!--l. 2583--><p class="noindent" >An INScore file is a list of textual expressions. A script expression is:
     <ul class="itemize1">
     <li class="itemize">a message: basically a textual OSC message extended to support URL like addresses and variables as
     parameters.
     </li>
     <li class="itemize">a variable declaration.
     </li>
     <li class="itemize">a foreign language script that may generate messages as output.
     </li>
     <li class="itemize">an end marker &#8217;<span 
class="pcrr8tn-">__END__</span>&#8217; to declare a script end. After the marker, the remaining part of the script
     will be ignored.</li></ul>
<a 
 id="dx18-84001"></a>
<dl class="list1"><dt class="list">
</dt><dd 
class="list">
<!--l. 2597--><p class="noindent" ><div class="minipage"><span 
class="ptmri8t-">expression</span> <img 
src="OSCMsg97x.png" alt="PICT" >
</div></dd></dl>
<a 
 id="dx18-84002"></a>
<!--l. 2600--><p class="noindent" >Messages and variables declarations must be followed by a semicolon, used as statements separator.
<!--l. 2604--><p class="noindent" >
<h3 class="sectionHead"><span class="titlemark">14.2    </span> <a 
 id="x18-8500014.2"></a>Messages</h3>
<!--l. 2606--><p class="noindent" >Messages are basically OSC messages that support the address extension scheme described in section <a 
href="OSCMsgch13.html#x17-7000013">13<!--tex4ht:ref: interaction --></a> p.<a 
href="OSCMsgch13.html#x17-7000013">106<!--tex4ht:ref: interaction --></a>.
Thus a script may be designed to initialize an INScore scene and external applications as well, including on remote
hosts.
<!--l. 2609--><p class="noindent" ><span 
class="ptmbc8t-">E<span 
class="small-caps">X</span><span 
class="small-caps">A</span><span 
class="small-caps">M</span><span 
class="small-caps">P</span><span 
class="small-caps">L</span><span 
class="small-caps">E</span> </span><br 
class="newline" />Initializing a score and an external application listening on port 12000 and running on a remote host named
<span 
class="pcrr8tn-">host.adomain.net</span>.
                                                                                 

                                                                                 
<div class="center" 
>
<!--l. 2613--><p class="noindent" >
<div 
class="colorbox" id="colorbox85"> <div class="minipage"><span 
class="pcrr8tn-x-x-90">/ITL/scene/score set gmnf &#8217;myscore.gmn&#8217;;</span><br 
class="newline" /><span 
class="pcrr8tn-x-x-90">host.adomain.net:12000/run 1;</span></div></div>
</div>
<!--l. 2615--><p class="noindent" >Messages parameters can be replaced by variables that are evaluated at parsing level. Variables are described in
section <a 
href="#x18-8700014.4">14.4<!--tex4ht:ref: scriptvar --></a>.
<!--l. 2619--><p class="noindent" >
<h3 class="sectionHead"><span class="titlemark">14.3    </span> <a 
 id="x18-8600014.3"></a>Types</h3>
<!--l. 2621--><p class="noindent" >Using OSC, the message parameters are typed by the OSC protocol. With their textual version, any parameter
is converted to an OSC type (i.e. int32, float or string) at parsing level. A special attention must be
given to strings in order to discriminate addresses and parameters. Strings intended as parameters
must:
     <ul class="itemize1">
     <li class="itemize">be quoted, using single or double quotes. Note that an ambiguous quote included in a string can be
     escaped using a &#8217;<span class="obeylines-h"><span class="verb"><span 
class="pcrr8tn-">\</span></span></span>&#8217;.
     </li>
     <li class="itemize">or make use of the following characters set: <span 
class="pcrr8tn-">[-a-zA-Z0-9]+ </span>or <span 
class="pcrr8tn-">[_a-zA-Z][_a-zA-Z0-9]*</span>.</li></ul>
<!--l. 2629--><p class="noindent" ><span 
class="ptmbc8t-">E<span 
class="small-caps">X</span><span 
class="small-caps">A</span><span 
class="small-caps">M</span><span 
class="small-caps">P</span><span 
class="small-caps">L</span><span 
class="small-caps">E</span> </span><br 
class="newline" />Different string parameter
<div class="center" 
>
<!--l. 2634--><p class="noindent" >
<div 
class="colorbox" id="colorbox86"> <div class="minipage"><span 
class="pcrr8tn-x-x-90">/ITL/scene/text set txt "Hello world"; ! string including a space must be quoted </span><br 
class="newline" /><span 
class="pcrr8tn-x-x-90">/ITL/scene/img set file &#8217;anImage.png&#8217;; ! dots must be quoted too </span><br 
class="newline" /><span 
class="pcrr8tn-x-x-90">/ITL/scene/foo set txt no_quotes_needed;</span></div></div>
</div>
<!--l. 2639--><p class="noindent" >
<h3 class="sectionHead"><span class="titlemark">14.4    </span> <a 
 id="x18-8700014.4"></a>Variables</h3>
<!--l. 2641--><p class="noindent" >A variable declaration associates a name with a list of parameters or a list of messages. Parameters must follow the
rules given in section <a 
href="#x18-8600014.3">14.3<!--tex4ht:ref: scripttypes --></a>. They may include previously declared variables. A message list must be enclosed in
parenthesis and a comma must be used as messages separator.
<a 
 id="dx18-87001"></a>
<dl class="list1"><dt class="list">
</dt><dd 
class="list">
                                                                                 

                                                                                 
<!--l. 2646--><p class="noindent" ><div class="minipage"><span 
class="ptmri8t-">variabledecl</span> <img 
src="OSCMsg98x.png" alt="PICT" >
</div></dd></dl>
<a 
 id="dx18-87002"></a>
<!--l. 2649--><p class="noindent" ><span 
class="ptmbc8t-">E<span 
class="small-caps">X</span><span 
class="small-caps">A</span><span 
class="small-caps">M</span><span 
class="small-caps">P</span><span 
class="small-caps">L</span><span 
class="small-caps">E</span> </span><br 
class="newline" />Variables declarations
<div class="center" 
>
<!--l. 2656--><p class="noindent" >
<div 
class="colorbox" id="colorbox87"> <div class="minipage"><span 
class="pcrr8tn-x-x-90">color = 200 200 200; </span><br 
class="newline" /><span 
class="pcrr8tn-x-x-90">colorwithalpha = $color 100; ! using another variable </span><br 
class="newline" /><span 
class="pcrr8tn-x-x-90">msgsvar= ( </span><span 
class="pcrr8tn-x-x-90">&#x00A0;</span><span 
class="pcrr8tn-x-x-90">&#x00A0;</span><span 
class="pcrr8tn-x-x-90">&#x00A0;</span><span 
class="pcrr8tn-x-x-90">&#x00A0;</span><span 
class="pcrr8tn-x-x-90">&#x00A0;                  ! a variable refering to a message list </span><br 
class="newline" /><span 
class="pcrr8tn-x-x-90">&#x00A0;</span><span 
class="pcrr8tn-x-x-90">&#x00A0;</span><span 
class="pcrr8tn-x-x-90">&#x00A0;       localhost:7001/world "Hello world", </span><br 
class="newline" /><span 
class="pcrr8tn-x-x-90">&#x00A0;</span><span 
class="pcrr8tn-x-x-90">&#x00A0;</span><span 
class="pcrr8tn-x-x-90">&#x00A0;       localhost:7001/world "how are you ?" );</span></div></div>
</div>
<!--l. 2659--><p class="noindent" >A variable may be used in place of any message parameter. A reference to a variable must have the form <span 
class="pcrr8tn-">$ident</span>
where <span 
class="pcrr8tn-">ident </span>is a previously declared variable. A variable is evaluated at parsing level and replaced by its
content.
<!--l. 2661--><p class="noindent" ><span 
class="ptmbc8t-">E<span 
class="small-caps">X</span><span 
class="small-caps">A</span><span 
class="small-caps">M</span><span 
class="small-caps">P</span><span 
class="small-caps">L</span><span 
class="small-caps">E</span> </span><br 
class="newline" />Using a variable to share a common position:
<div class="center" 
>
<!--l. 2666--><p class="noindent" >
<div 
class="colorbox" id="colorbox88"> <div class="minipage"><span 
class="pcrr8tn-x-x-90">x = 0.5;</span><br 
class="newline" /><span 
class="pcrr8tn-x-x-90">/ITL/scene/a x $x;</span><br 
class="newline" /><span 
class="pcrr8tn-x-x-90">/ITL/scene/b x $x;</span></div></div>
</div>
<!--l. 2668--><p class="noindent" >Variables can be used in interaction messages as well, which may also use the variables available in the interaction
context (see section <a 
href="OSCMsgch13.html#x17-7500013.2">13.2<!--tex4ht:ref: interactvar --></a> p.<a 
href="OSCMsgch13.html#x17-7500013.2">111<!--tex4ht:ref: interactvar --></a>). To differentiate between a <span 
class="ptmri8t-">script </span>and an <span 
class="ptmri8t-">interaction </span>variable, the latter must be
quoted to be passed as strings and to prevent their evaluation by the parser.
<!--l. 2670--><p class="noindent" ><span 
class="ptmbc8t-">E<span 
class="small-caps">X</span><span 
class="small-caps">A</span><span 
class="small-caps">M</span><span 
class="small-caps">P</span><span 
class="small-caps">L</span><span 
class="small-caps">E</span> </span><br 
class="newline" />Using variables in interaction messages: $sx is evaluated at event occurrence and $y is evaluated at parsing level.
<div class="center" 
>
<!--l. 2674--><p class="noindent" >
<div 
class="colorbox" id="colorbox89"> <div class="minipage"><span 
class="pcrr8tn-x-x-90">y = 0.5;</span><br 
class="newline" /><span 
class="pcrr8tn-x-x-90">/ITL/scene/foo watch mouseDown (/ITL/scene/foo "$sx" $y);</span></div></div>
</div>
                                                                                 

                                                                                 
<!--l. 2679--><p class="noindent" >
<h3 class="sectionHead"><span class="titlemark">14.5    </span> <a 
 id="x18-8800014.5"></a>Message based parameters</h3>
<!--l. 2681--><p class="noindent" >Similarly to message based variables (see section <a 
href="OSCMsgch13.html#x17-7900013.2.4">13.2.4<!--tex4ht:ref: msgvar --></a> p.<a 
href="OSCMsgch13.html#x17-7900013.2.4">114<!--tex4ht:ref: msgvar --></a>), a message parameter may also use the result of a
<span 
class="pcrr8tn-">get </span>message as parameters specified like a message based variable. The message must be enclosed in parameters
with a leading $ sign.
<a 
 id="dx18-88001"></a>
<dl class="list1"><dt class="list">
</dt><dd 
class="list">
<!--l. 2685--><p class="noindent" ><div class="minipage"><span 
class="ptmri8t-">msgparam</span> <img 
src="OSCMsg99x.png" alt="PICT" >
</div></dd></dl>
<a 
 id="dx18-88002"></a>
<!--l. 2688--><p class="noindent" ><span 
class="ptmbc8t-">E<span 
class="small-caps">X</span><span 
class="small-caps">A</span><span 
class="small-caps">M</span><span 
class="small-caps">P</span><span 
class="small-caps">L</span><span 
class="small-caps">E</span> </span><br 
class="newline" />Displaying INScore version using a message parameter:
<div class="center" 
>
<!--l. 2690--><p class="noindent" >
<div 
class="colorbox" id="colorbox90"> <div class="minipage"><span 
class="pcrr8tn-x-x-90">/ITL/scene/version set txt "INScore version is" $(/ITL get version);</span>
</div></div>
</div>
<!--l. 2692--><p class="noindent" ><span 
class="ptmbc8t-">N<span 
class="small-caps">O</span><span 
class="small-caps">T</span><span 
class="small-caps">E</span> </span><br 
class="newline" />Message based parameters are evaluated by the parser. Thus when the system state is modified by a script before a
message parameter, these modifications won&#8217;t be visible at the time of the parameter evaluation because all the
messages will be processed by the next time task. For example:<br 
class="newline" />
<div class="center" 
>
<!--l. 2695--><p class="noindent" >
<div 
class="colorbox" id="colorbox91"> <div class="minipage"><span 
class="pcrr8tn-x-x-90">/ITL/scene/obj x 0.1;</span><br 
class="newline" /><span 
class="pcrr8tn-x-x-90">/ITL/scene/foo x $(/ITL/scene/foo get x);</span></div></div>
</div>
<!--l. 2696--><p class="noindent" >x position of <span 
class="pcrr8tn-">/ITL/scene/foo </span>will be set to x position of <span 
class="pcrr8tn-">/ITL/scene/obj </span>at the time of the script evaluation (that
may be different to 0.1).
<!--l. 2700--><p class="noindent" >
<h3 class="sectionHead"><span class="titlemark">14.6    </span> <a 
 id="x18-8900014.6"></a>Languages</h3>
<a 
 id="dx18-89001"></a>
<a 
 id="dx18-89002"></a>
<!--l. 2705--><p class="noindent" >INScore supports Javascript and Lua as scripting languages. Javascript is embedded by default (using the v8
                                                                                 

                                                                                 
engine<span class="footnote-mark"><a 
href="OSCMsg19.html#fn1x193"><sup class="textsuperscript">1</sup></a></span><a 
 id="x18-89003f1"></a> ). INScore needs to be
recompiled to embed the Lua engine<span class="footnote-mark"><a 
href="OSCMsg20.html#fn2x193"><sup class="textsuperscript">2</sup></a></span><a 
 id="x18-89004f2"></a> .
A script section is indicated similarly to a Javascript section in html i.e. enclosed in an opening <span 
class="pcrr8tn-">&#x003C;? </span>and a closing
<span 
class="pcrr8tn-">?&#x003E;</span>.
<a 
 id="dx18-89005"></a>
<dl class="list1"><dt class="list">
</dt><dd 
class="list">
<!--l. 2708--><p class="noindent" ><div class="minipage"><span 
class="ptmri8t-">script</span> <img 
src="OSCMsg100x.png" alt="PICT" >
</div></dd></dl>
<a 
 id="dx18-89006"></a>
<a 
 id="dx18-89007"></a>
<!--l. 2712--><p class="noindent" >The principle of using an embedded programming language in script files is the following: <span 
class="ptmri8t-">javascript </span>or <span 
class="ptmri8t-">lua </span>sections
are given to the corresponding engine and are expected to produce INScore messages on output. These messages
are then parsed as if replacing the corresponding script section.
<!--l. 2715--><p class="noindent" >Note that INScore variables are exported to the current language environment.
<!--l. 2717--><p class="noindent" ><span 
class="ptmbc8t-">E<span 
class="small-caps">X</span><span 
class="small-caps">A</span><span 
class="small-caps">M</span><span 
class="small-caps">P</span><span 
class="small-caps">L</span><span 
class="small-caps">E</span></span>
<div class="center" 
>
<!--l. 2722--><p class="noindent" >
<div 
class="colorbox" id="colorbox92"> <div class="minipage">  <span 
class="pcrr8tn-x-x-90">&#x003C;?javascript </span><br 
class="newline" />   <span 
class="pcrr8tn-x-x-90">"/ITL/scene/version set &#8217;txt&#8217; &#8217;Javascript v." + version() + "&#8217;;"; </span><br 
class="newline" />  <span 
class="pcrr8tn-x-x-90">?&#x003E;</span></div></div>
</div>
<!--l. 2725--><p class="noindent" >A single persistent context is created at application level and for each scene. It allows scripts to reuse previously
defined functions and thus to design more structured scripts.
<h4 class="subsectionHead"><span class="titlemark">14.6.1    </span> <a 
 id="x18-9000014.6.1"></a>The Javascript object</h4>
<!--l. 2733--><p class="noindent" >The Javascript engine is available at runtime at the address <span 
class="pcrr8tn-">/ITL/</span><span 
class="pcrro8t-">scene</span><span 
class="pcrr8tn-">/javascript</span>. It has a <span 
class="pcrr8tn-">run </span>method that
takes a javascript string as parameter.
<a 
 id="dx18-90001"></a>
<dl class="list1"><dt class="list">
</dt><dd 
class="list">
<!--l. 2737--><p class="noindent" ><div class="minipage"><span 
class="ptmri8t-">javascript</span> <img 
src="OSCMsg101x.png" alt="PICT" >
</div></dd></dl>
                                                                                 

                                                                                 
<a 
 id="dx18-90002"></a>
<!--l. 2740--><p class="noindent" >The <span 
class="pcrr8tn-">run </span>method evaluates the code. Similarly to javascript sections in scripts, the output of the evaluation is
expected to be a string containing valid INScore messages that are next executed. Actually, including a javascript
section in a script is equivalent to send the <span 
class="pcrr8tn-">run </span>message with the same code as parameter to the javascript
object.
<!--l. 2743--><p class="noindent" >The Javascript engine is based on V8 that implements ECMAScript as specified in ECMA-262, 5th edition,
extended with additional functions:
     <ul class="itemize1">
     <li class="itemize"><span 
class="pcrb8t-">version() </span>: gives the javascript engine version number as a string.
     </li>
     <li class="itemize"><span 
class="pcrb8t-">print(val1 [, val2 [, ...]]) </span>:  print  the  arguments  to  the  OSC  standard  output.  The
     arguments list is prefixed by &#8217;javascript:&#8217;. The function is provided for debug purpose.
     </li>
     <li class="itemize"><span 
class="pcrb8t-">readfile(file) </span>: read a file and returns its content as a string. The file name could be specified
     as an absolute or relative path. When relative, the file is searched in the application current <span 
class="pcrr8tn-">rootPath</span>
     (see section <a 
href="OSCMsgch7.html#x11-390007.1">7.1<!--tex4ht:ref: applmgmt --></a> p.<a 
href="OSCMsgch7.html#x11-390007.1">54<!--tex4ht:ref: applmgmt --></a>).
     </li>
     <li class="itemize"><span 
class="pcrb8t-">post(address [,...]) </span>: build an OSC message and post it for delayed processing i.e. to be
     processed by the next time task. <span 
class="pcrr8tn-">address </span>is an OSC or an extended OSC address. Optional arguments
     are the message parameters.</li></ul>
<!--l. 2752--><p class="noindent" ><span 
class="ptmbc8t-">E<span 
class="small-caps">X</span><span 
class="small-caps">A</span><span 
class="small-caps">M</span><span 
class="small-caps">P</span><span 
class="small-caps">L</span><span 
class="small-caps">E</span></span>
<div class="center" 
>
<!--l. 2759--><p class="noindent" >
<div 
class="colorbox" id="colorbox93"> <div class="minipage">  <span 
class="pcrr8tn-x-x-90">&#x003C;?javascript </span><br 
class="newline" />   <span 
class="pcrr8tn-x-x-90">post ("/ITL/scene/obj", "dalpha", -1);";</span><br 
class="newline" />   <span 
class="pcrr8tn-x-x-90">The message /ITL/scene/obj dalpha -1 </span><br 
class="newline" />   <span 
class="pcrr8tn-x-x-90">will be evaluated by the next time task. </span><br 
class="newline" /><span 
class="pcrr8tn-x-x-90">?&#x003E;</span></div></div>
</div>
                                                                                 

                                                                                 
<!--l. 2776--><div class="crosslinks"><p class="noindent">[<a 
href="OSCMsgch15.html" >next</a>] [<a 
href="OSCMsgch13.html" >prev</a>] [<a 
href="OSCMsgch13.html#tailOSCMsgch13.html" >prev-tail</a>] [<a 
href="OSCMsgch14.html" >front</a>] [<a 
href="OSCMsg3.html#OSCMsgch14.html" >up</a>] </p></div>
<!--l. 2776--><p class="noindent" ><a 
 id="tailOSCMsgch14.html"></a>  
</body></html> 
