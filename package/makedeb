
arch	:= $(shell arch)
debarch := $(shell dpkg --print-architecture)
dist	:= ubuntu-14.04
package := INScore-$(version)-$(dist)-$(arch).deb
viewer	:= inscoreviewer
lib	:= libINScore.so
sovers  := 1
control := debian/DEBIAN/control
tmp		:= __tmp__


files = $(shell cd debian && find usr -type f)

deb:
	[ -d debian/usr/bin ] && rm -f debian/usr/bin/* || mkdir debian/usr/bin
	cp ../build/linux/$(viewer) debian/usr/bin/$(viewer)-$(version)
	cd debian/usr/bin && ln -s $(viewer)-$(version) $(viewer)
	cp ../tools/IBundle/IBundle debian/usr/bin/
	[ -d debian/usr/lib ] && rm -f debian/usr/lib/* || mkdir debian/usr/lib
	cp ../build/linux/$(lib).$(version) debian/usr/lib
	cd debian/usr/lib && ln -s $(lib).$(version) $(lib).$(sovers) && ln -s $(lib).$(sovers) $(lib)
	[ -d debian/usr/share/inscore ] && rm -rf debian/usr/share/inscore/* || mkdir debian/usr/share/inscore
	cp -r INScore-$(version)/* debian/usr/share/inscore
	make -f makedeb md5sums
	@echo set architecture to $(debarch)
	sed -e 's/^Architecture..*/Architecture: $(debarch)/' $(control) > $(tmp)
	mv $(tmp) $(control)
	fakeroot dpkg-deb --build debian
	mv debian.deb $(package)

md5sums:
	@echo compute md5sums
	@cd debian && md5sum $(files) > DEBIAN/md5sums


clean:
	rm -f debian/usr/bin/*
	rm -f debian/usr/lib/*
	rm -f debian/DEBIAN/md5sums
	rm -rf debian/usr/share/inscore/*

