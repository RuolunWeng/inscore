<!doctype html>
<html>
	<head>
		<script>
// Automatic refresh of the image.
setInterval(function() {
	var url = document.getElementById("url").value;
	var xhr = new XMLHttpRequest();
	xhr.open("GET",url);
	xhr.responseType = "blob";
	xhr.onreadystatechange = function() {
	        if (xhr.readyState == xhr.DONE && xhr.status == 200) {
			// Render the downloaded image
			var myblob = xhr.response;
			var image = document.getElementById("image");

			image.addEventListener("load", function (evt) {
				URL.revokeObjectURL(evt.target.src);
			});
			image.src = URL.createObjectURL(myblob);
		}
	}
	xhr.send(null);
	}, 2000);

// Get the score version
function sendGetVersion() {
	var url = document.getElementById("url").value;
	var xhr = new XMLHttpRequest();
	xhr.open("GET", url + "/version");
	xhr.responseType = "json";
	xhr.onreadystatechange = function() {
	        if (xhr.readyState == xhr.DONE && xhr.status == 200) {
			var version = xhr.response;
			updateLog("Score image version : " + version.version);
		}
	}
	xhr.send(null);
}

// Send a message with inscore script to the server
function sendCommands(inscoreScript) {
	// Get commands and remove line break and tab
	var commands = inscoreScript.replace(/\r?\n|\r|\t/g, " ");
	if (commands) {
		var url = document.getElementById("url").value;
		var xhr = new XMLHttpRequest();
		xhr.open("POST", url);
		xhr.responseType = "json";
		xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		xhr.setRequestHeader("Content-length", commands.length);
		xhr.onreadystatechange = function() {
			// Response is 200 if success or 400 if error
			if (xhr.readyState == xhr.DONE && xhr.status == 400) {
				// In case of error, write log.
				updateLog(xhr.response.error);
			}
		}
		xhr.send("data=" + commands);
	}
}
function init() {
	// Add listener for mouse click to post mouse click position
	document.getElementById('image').onclick = function(e) {
		var X = e.pageX - document.getElementById('image').offsetLeft;
		var Y = e.pageY - document.getElementById('image').offsetTop;
		var data = "x=" + X + "&y=" + Y;

		var url = document.getElementById("url").value;
		var xhr = new XMLHttpRequest();
		xhr.open("POST", url + "/click");
		xhr.responseType = "json";
		xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		xhr.setRequestHeader("Content-length", data.length);
		xhr.onreadystatechange = function() {
			// Response is 200 if success or 400 if error
			if (xhr.readyState == xhr.DONE && xhr.status == 400) {
				// In case of error, write log.
				updateLog(xhr.response.error);
			}
		}
		xhr.send(data);
	}
}

// Update the log div
function updateLog(message) {
	// Display text message under form with the date.
	document.getElementById("log").innerHTML = message;
}


/******* functions to add possibility to drag and drop file on INScore scene image **********/
function Init() {
	var filedrag = document.getElementById("image");
	filedrag.addEventListener("dragover", FileDragHover, false);
	filedrag.addEventListener("dragleave", FileDragHover, false);
	filedrag.addEventListener("drop", UploadFile, false);
}

function FileDragHover(e) {
	e.stopPropagation();
	e.preventDefault();
	e.target.className = (e.type == "dragover" ? "hover" : "");
}

function UploadFile(e) {
	FileDragHover(e);
	var files = e.target.files || e.dataTransfer.files;
	var file = files[0];

	var reader = new FileReader();

	// Load .inscore file only
	var ext = file.name.split('.').pop();
	if (ext == "inscore"){
		reader.readAsText(file);
		reader.onloadend = function(e) {
			alert(reader.result);
			sendCommands(reader.result);
		}
	}
}

		</script>
	</head>
	<body onload="init()">
		<div>
			<h1>INScore viewer</h1>
			<p>Type url of INScore server : <input id="url" type="text" value="http://localhost:8000" /></p>
			<p>
			<form name="myform">
				Send get version message : <input name="versionSubmit" type="button" value="submit" onclick="javascript:sendGetVersion();return false;"/>
				<br/>
				Text messagee to submit to the server :
<textarea id="cmd" rows="5" cols="50">
/ITL/scene/text set txt "Test text message";
/ITL/scene/text fontStyle "italic";
/ITL/scene/text fontSize 25;
</textarea>
				<input name="submit2" type="button" value="submit" onclick="javascript:sendCommands(document.forms['myform'].cmd.value);return false;"/>
			</form>
			</p>
		</div>
		<div>
			<img style="border : 1px solid black;" src="http://localhost:8000" id="image"/>
		</div>
		<div>Log : <span id="log"></span></div>
	</body>
</html>
