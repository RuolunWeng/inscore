<!doctype html>
<html>
	<head>
		<script>

// Id for the request.
var requestId = 0;
// The websocket
var ws;

// Update the websocket status
function updateStatus(id, message) {
	document.getElementById(id).innerHTML = message;
}

// Update the log
function updateLog(message) {
	// Display text message under form with the date.
	document.getElementById("log").innerHTML = message;
}

function loadWebSocket() {
	if (window.WebSocket) {
		var url = "ws://localhost:7100";
		ws = new WebSocket(url);
		updateStatus("wsStatus", "webSocket supported !");

		ws.onopen = function() {
			updateStatus("wsStatus", "Connected to WebSocket server!");
			// Load the image of the score
			var getJsonObject = { id : "" + requestId++, method : "image"};
			ws.send(JSON.stringify(getJsonObject));
		}

		// Receive message from websocket server
		ws.onmessage = function(e) {
			// Parse the message
			var response = JSON.parse(e.data);

			if(response.status == "ERROR") {
				updateLog("Error message : " + response.error);
				return;
			}

			// Check message type
			if(response.notification == true) {
				// If notification, get the image of the new score.
				var getJsonObject = { id : requestId++, method : "image"};
				ws.send(JSON.stringify(getJsonObject));
			} else if ("image" in response) {
				// render image
				renderImg(response);
			} else if ("version" in response) {
				// Response to an get version request
				updateLog("Score image version : " + response.version);
			}
		}

		// event Close websocket
		ws.onclose = function() {
			updateStatus("wsStatus", "WebSocket closed!");
		}
		ws.onerror = function(e) {
			updateStatus("wsStatus", "WebSocket error : " + e.data);
		}

		// Add listener for mouse click to post mouse click position
		document.getElementById('image').onclick = function(e) {
			var X = e.pageX - document.getElementById('image').offsetLeft;
			var Y = e.pageY - document.getElementById('image').offsetTop;

			var clickJsonObject = { id : requestId++, method : "click", x : X, y : Y };
			ws.send(JSON.stringify(clickJsonObject));
		}
	} else {
		updateStatus("wsStatus", "Your browser does NOT support webSocket.");
	}
}

// Render the downloaded image
function renderImg(response) {
	var img = document.getElementById("image");
	img.src = "data:" + response.mimeType + ";base64," + response.image;
 }
 
function sendGetVersion() {
	var versionJsonObject = { id : requestId, method : "version"};
	ws.send(JSON.stringify(versionJsonObject));
}

// Send a message to the web socket
function sendCommands(inscoreScript) {
	// Get commands and remove line break and tab
	var commands = inscoreScript.replace(/\r?\n|\r|\t/g, " ");
	if (commands) {
		if (ws.readyState == 1) {
			// Send the commands
			var postJsonObject = { id : requestId, method : "post", data : commands};
			ws.send(JSON.stringify(postJsonObject));
		} else {
			alert("The websocket is not open! try refreshing your browser");
		}
	}
}

/******* functions to add possibility to drag and drop file on INScore scene image **********/
function Init() {
	var filedrag = document.getElementById("image");
	filedrag.addEventListener("dragover", FileDragHover, false);
	filedrag.addEventListener("dragleave", FileDragHover, false);
	filedrag.addEventListener("drop", UploadFile, false);
}

function FileDragHover(e) {
	e.stopPropagation();
	e.preventDefault();
	e.target.className = (e.type == "dragover" ? "hover" : "");
}

function UploadFile(e) {
	FileDragHover(e);
	var files = e.target.files || e.dataTransfer.files;
	var file = files[0];

	var reader = new FileReader();

	// Load .inscore file only
	var ext = file.name.split('.').pop();
	if (ext == "inscore"){
		reader.readAsText(file);
		reader.onloadend = function(e) {
			alert(reader.result);
			sendCommands(reader.result);
		}
	}
}

</script>
	</head>
	<body onload="loadWebSocket(); Init();">
		<div>
			<form name="myform">
				Send get version message : <input name="versionSubmit" type="button" value="submit" onclick="javascript:sendGetVersion();return false;"/>
				<br/>
				A text message to submit to the websocket server :
<textarea id="cmd" rows="5" cols="50">
/ITL/scene/text set txt "toto part en vacances";
/ITL/scene/text fontStyle "italic";
/ITL/scene/text fontSize 25;
</textarea>
				<input name="submit2" type="button" value="submit" onclick="javascript:sendCommands(document.forms['myform'].cmd.value);return false;"/>
			</form>
			<div>Screenshot of the scene served by a websocket server.</div>
			<div><span id="message"></span></div>
			<p></p>
			<img style="border : 1px solid black;" id="image" src=""/>
		</div>
		<div>Status : <span id="wsStatus"></span></div>
		<div>Log : <span id="log"></span></div>

	</body>
</html>

