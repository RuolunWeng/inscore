#
# makefile for testing the INScore engine output
# the principle is the following:
# a pdf target generates pdf files for a set of scripts files given in scripts.txt
# 
# a validate target makes the comparison of files generated by different versions
#
###################################################################################
# Tools required to run the validation tests :
#	./INScoreVersion
#	./SendOSC
# these tools are available as source code from the tools folder, you must compile
# them, a makefile is provided.
#
#	./inscore2pdf	a shell script that is included in this folder
#
###################################################################################
# Tools required to run the memory leak tests :
# 	./INScoreNOView : 	the default tool to run the tests
#						should be compiled using the project cmake tool 
#
###################################################################################

version	= $(shell ./INScoreVersion)
pwd	  = $(shell pwd)
TOOL = ./INScoreNOView

files 			= $(shell grep -v '^\#' validate/samplescripts.txt)
graphicfiles 	= $(shell grep -v '^\#' validate/graphicscripts.txt)
syncfiles 		= $(shell grep -v '^\#' validate/syncscripts.txt)
javafiles 		= $(shell grep -v '^\#' validate/javascripts.txt)
logfiles 		= $(shell grep -v '^\#' validate/logs.txt)
savefiles 		= $(shell grep -v '^\#' validate/save.txt)
regressionfiles = $(shell grep -v '^\#' validate/regression.txt)

pdfout  		:= $(patsubst ../%.inscore, $(version)/%.pdf, $(files))
pdfgraphicout 	:= $(patsubst ../%.inscore, $(version)/%.pdf, $(graphicfiles))
pdfsyncout 		:= $(patsubst ../%.inscore, $(version)/%.pdf, $(syncfiles))
pdfjavaout 		:= $(patsubst ../%.inscore, $(version)/%.pdf, $(javafiles))
pdfregressionout:= $(patsubst ../%.inscore, $(version)/%.pdf, $(regressionfiles))
logout 			:= $(patsubst ../%.inscore, $(version)/%.log, $(logfiles))
inscoreout 		:= $(patsubst ../%.inscore, $(version)/%.inscore, $(savefiles))

leakout 	:= $(patsubst ../%.inscore, $(version)/$(TOOL)/%.leak.txt, $(files))
leaksfiles  := $(patsubst ../%.inscore, $(version)/%.leaks.out, $(files))

allpdf 		:= $(shell [ -d $(version) ] && find $(version) -name "*.pdf" 2>/dev/null)
validpdf 	:= $(patsubst %.pdf, %.outpdf, $(allpdf))

allLog 		:= $(shell [ -d $(version) ] && find $(version) -name "*.log" 2>/dev/null)
validlog 	:= $(patsubst %.log, %.outlog, $(allLog))

allinscore 		:= $(shell [ -d $(version) ] && find $(version) -name "*.inscore" 2>/dev/null)
validinscore 	:= $(patsubst %.inscore, %.outinscore, $(allinscore))


nodlost	= "definitely lost: 0"
noilost	= "indirectly lost: 0"
noplost	= "possibly lost: 0"


#test:
#	echo $(files)

all:
	@echo "=========================================="
	@echo " Make sure that INScoreViewer is running!"
	@echo "=========================================="
	make log
	make save
	make pdf

pdf:
	make pdfgraphic
	make pdfsync
	make pdfjava
	make basic
	make pdfregression

log: 
	@echo "----------- Generating log files"
	make _log

save : 
	@echo "----------- Generating inscore files"
	./SendOSC 7000 /ITL/scene reset
	make _save

_log: $(logout)

_save : $(inscoreout)

basic:
	@echo "----------- Running basic scripts"
	make files

pdfgraphic:
	@echo "----------- Checking graphical elements"
	make filesgraphic
	
pdfsync:
	@echo "----------- Checking synchronization modes"
	make filessync
	
pdfjava:
	@echo "----------- Checking javascript examples"
	make filesjava
	
pdfregression:
	@echo "----------- Regression tests"
	make filesregression
	
clean: 
	make pdfclean
	make logclean
	make saveclean

pdfclean: 
	rm -f $(pdfout) $(pdfgraphicout) $(pdfsyncout) $(pdfjavaout) $(pdfregressionout)

logclean: 
	rm -f $(logout)

saveclean: 
	rm -f $(inscoreout)

help:
	@echo "Makefile for testing the INScore engine output. Available targets are:"
	@echo " 'all' 		: generates pdf output files, inscore output files and log files"
	@echo " 'pdf' 		: generates pdf files for inscore files recursively enclosed in this folder"
	@echo " 'log' 		: generates log files in order to check inscore logs"
	@echo " 'save' 		: generates inscore files in order to check the save method"
	@echo "  output files are generated under the current INScore version number."
	@echo " 'validate VERSION=another_version': compares the current version with another one"
	@echo " 'checkleaks [TOOL=a_check_tool]': check memory leaks using a given tool (default INScoreNOView)"
	@echo " 'tools'     : rebuild the required tools"

tools:
	make -C tools

INScoreVersion:
	make -C tools

validate: $(validpdf) $(validlog) $(validinscore)
	@echo Validating version $(VERSION) with $(version)

checkleaks: $(leakout)
	make showleaks

showleaks: $(leaksfiles)

files: $(pdfout)
	@./forcepdfdate 20100101120000 $(pdfout)

filesgraphic: $(pdfgraphicout)
	@./forcepdfdate 20100101120000 $(pdfgraphicout)

filessync: $(pdfsyncout)
	@./forcepdfdate 20100101120000 $(pdfsyncout)

filesjava: $(pdfjavaout)
	@./forcepdfdate 20100101120000 $(pdfjavaout)
	
filesregression: $(pdfregressionout)
	@./forcepdfdate 20100101120000 $(pdfregressionout)

	
$(version)/$(TOOL)/%.leak.txt: %.inscore
	@[ -d $(@D) ] || mkdir -p $(@D)
	valgrind --leak-check=full --suppressions=valgrindignored.txt --log-file=$@ $(TOOL) $(pwd)/$<
	
$(version)/%.pdf: ../%.inscore
	@[ -d $(@D) ] || mkdir -p $(@D)
	@./inscore2pdf $< $@

$(version)/%.log: ../%.inscore
	@[ -d $(@D) ] || mkdir -p $(@D)
	@./inscore2log $< $@

$(version)/%.inscore: ../%.inscore
	@[ -d $(@D) ] || mkdir -p $(@D)
	@./inscore2inscore $< $@
	

$(version)/%.leaks.out: $(version)/$(TOOL)/%.leak.txt	
	@grep $(nodlost) $< > /dev/null || echo "$< : definitely lost bytes"
	@grep $(noilost) $< > /dev/null || echo "$< : indirectly lost bytes"
	@grep $(noplost) $< > /dev/null || echo "$< : possibly lost bytes"



%.outpdf: %.pdf
	$(eval tmp := $(patsubst $(version)/%, $(VERSION)/%, $<))	
	@[ -f  $(tmp) ] || echo $< : new file
	$(eval ignored := $(shell grep $< $(version)/ignore.$(VERSION).txt 2>/dev/null || echo _none_))
	@[ -f  $(ignored) ] || (diff $< $(tmp) 2>/dev/null >/dev/null || ([ -f  $(tmp) ] && echo "open $< $(patsubst $(version)/%, $(VERSION)/%, $<) # to check changes"; true))
	
%.outlog: %.log
	$(eval tmp := $(patsubst $(version)/%, $(VERSION)/%, $<))	
	@[ -f  $(tmp) ] || echo $< : new file
	$(eval ignored := $(shell grep $< $(version)/ignore.$(VERSION).txt 2>/dev/null || echo _none_))
	@[ -f  $(ignored) ] || (diff $< $(tmp) 2>/dev/null >/dev/null || ([ -f  $(tmp) ] && echo "open $< $(patsubst $(version)/%, $(VERSION)/%, $<) # to check changes"; true))

%.outinscore: %.inscore
	$(eval tmp := $(patsubst $(version)/%, $(VERSION)/%, $<))	
	@[ -f  $(tmp) ] || echo $< : new file
	$(eval ignored := $(shell grep $< $(version)/ignore.$(VERSION).txt 2>/dev/null || echo _none_))
	@[ -f  $(ignored) ] || (diff $< $(tmp) 2>/dev/null >/dev/null || ([ -f  $(tmp) ] && echo "open -t $< $(patsubst $(version)/%, $(VERSION)/%, $<) # to check changes"; true))
