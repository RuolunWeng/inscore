#
# makefile for testing the INScore engine output
# the principle is the following:
# an image target generates image files using guido2image for all gmn files
# in gmn-examples and in regression-tests
# 
# a validate target makes the comparison of files generated by different versions
#

version	= $(shell ./INScoreVersion | cut -d' ' -f 3)
pwd	  = $(shell pwd)
TOOL = ./INScoreNOView

files = $(shell find . -name "*.inscore")
pdfout  	:= $(patsubst ./%.inscore, $(version)/%.pdf, $(files))
leakout 	:= $(patsubst ./%.inscore, $(version)/$(TOOL)/%.leak.txt, $(files))
leaksfiles  := $(patsubst ./%.inscore, $(version)/%.leaks.out, $(files))

allpdf 		= $(shell [ -d $(version) ] && find $(version) -name "*.pdf")
validpdf 	= $(patsubst %.pdf, %.outpdf, $(allpdf))


nodlost	= "definitely lost: 0"
noilost	= "indirectly lost: 0"
noplost	= "possibly lost: 0"


help:
	@echo "Makefile for testing the INScore engine output. Available targets are:"
	@echo "'images' : makes pdf files for inscore files recursively enclosed in this folder"
	@echo "           the pdf files output folder name is the current INScore version number."
	@echo "'validate VERSION=another_version': compares the current version with another one"
	@echo "'checkleaks [TOOL=a_check_tool]': check memory leaks using a given tool (default INScoreNOView)"

images: forcepdfdate INScoreVersion
	@echo "Make sure that INScoreViewer is running!"
	make files

validate: $(validpdf)
	@echo Validating version $(VERSION) with $(version)

checkleaks: $(leakout)
	make showleaks

showleaks: $(leaksfiles)

files: $(pdfout)
	./forcepdfdate 20100101120000 $(pdfout)

$(version)/$(TOOL)/%.leak.txt: %.inscore
	@[ -d $(@D) ] || mkdir -p $(@D)
	valgrind --leak-check=full --suppressions=valgrindignored.txt --log-file=$@ $(TOOL) $(pwd)/$<
	
$(version)/%.pdf: %.inscore
	@[ -d $(@D) ] || mkdir -p $(@D)
	./inscore2pdf $< $@
	@sleep 1

$(version)/%.leaks.out: $(version)/$(TOOL)/%.leak.txt	
	@grep $(nodlost) $< > /dev/null || echo "$< : definitely lost bytes"
	@grep $(noilost) $< > /dev/null || echo "$< : indirectly lost bytes"
	@grep $(noplost) $< > /dev/null || echo "$< : possibly lost bytes"


%.out: %.pdf
	@diff $< $(patsubst $(version)/%, $(VERSION)/%, $<) || echo "open $<  $(patsubst $(version)/%, $(VERSION)/%, $<) to check changes"
	
%.outpdf: %.pdf
	$(eval tmp := $(patsubst $(version)/%, $(VERSION)/%, $<))	
	@[ -f  $(tmp) ] || echo $< : new file
	$(eval ignored := $(shell grep $< $(version)/ignore.$(VERSION).txt 2>/dev/null || echo _none_))
	@[ -f  $(ignored) ] || (diff $< $(tmp) 2>/dev/null >/dev/null || [ -f  $(tmp) ] && echo "open $< $(patsubst $(version)/%, $(VERSION)/%, $<) # to check changes"; true)

